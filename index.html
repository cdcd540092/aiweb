<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="UTF-8">
  <title>èªéŸ³è¾¨è­˜ + èªè¨€æ¨¡å‹æ§åˆ¶</title>
  <style>
    body { margin: 0; overflow: hidden; background-color: black; }
    canvas { display: block; }

    #inputContainer {
      pointer-events: auto;
      position: fixed;
      top: 10px;
      left: 10px;
      background: rgba(0, 0, 0, 0.6);
      padding: 10px;
      border-radius: 5px;
      z-index: 9999;
      color: white;
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
      width: 700px;
    }

    #inputBox {
      font-size: 20px;
      width: 100%;
      color: white;
      background: transparent;
      border: 1px solid white;
      padding: 5px;
      font-family: monospace;
      box-sizing: border-box;
    }

    #buttonRow {
      margin-top: 6px;
      display: flex;
      gap: 6px;
    }

    #sendBtn, #voiceBtn {
      flex: 1;
      font-size: 14px;
      padding: 4px 6px;
      border-radius: 4px;
      border: 1px solid #ccc;
      background: #222;
      color: #fff;
      cursor: pointer;
    }

    #sendBtn:active, #voiceBtn:active {
      transform: translateY(1px);
    }

    #status {
      margin-top: 4px;
      font-size: 12px;
      opacity: 0.8;
      min-height: 1.2em;
    }

    #answerBox {
      margin-top: 6px;
      font-size: 14px;
      white-space: pre-wrap;
      word-break: break-word;
      max-height: 180px;
      overflow-y: auto;
      border-top: 1px solid rgba(255,255,255,0.2);
      padding-top: 4px;
    }
  </style>
</head>
<body>
  <div id="inputContainer">
    <input type="text" id="inputBox" placeholder="èªéŸ³æˆ–æ–‡å­—è¼¸å…¥å…§å®¹...">
    <div id="buttonRow">
      <button id="voiceBtn">ğŸ¤ èªéŸ³ï¼ˆEnterï¼‰</button>
      <button id="sendBtn">ğŸ“¤ é€å‡ºçµ¦æ¨¡å‹</button>
    </div>
    <div id="status">ç‹€æ…‹ï¼šå¾…å‘½</div>
    <div id="answerBox"></div>
  </div>

  <audio id="startBeep" src="ding.mp3" preload="auto"></audio>

  <script src="https://cdn.jsdelivr.net/npm/three@0.155.0/build/three.min.js"></script>
  <script>
    // =========================
    // 1. Three.js ç«‹æ–¹é«”å ´æ™¯
    // =========================
    const scene = new THREE.Scene();
    const camera = new THREE.PerspectiveCamera(75, window.innerWidth / window.innerHeight, 0.1, 1000);
    const renderer = new THREE.WebGLRenderer({ antialias: true });
    renderer.setSize(window.innerWidth, window.innerHeight);
    document.body.appendChild(renderer.domElement);

    const geometry = new THREE.BoxGeometry();
    const material = new THREE.MeshNormalMaterial();
    const cube = new THREE.Mesh(geometry, material);
    scene.add(cube);
    camera.position.z = 5;

    // éµç›¤æ§åˆ¶ + Enter å•Ÿå‹•èªéŸ³
    window.addEventListener('keydown', (event) => {
      switch (event.key) {
        case 'ArrowLeft': rotateLeft(); break;
        case 'ArrowRight': rotateRight(); break;
        case 'ArrowUp': rotateUp(); break;
        case 'ArrowDown': rotateDown(); break;
        case 'Enter': playBeepAndStartRecognition(); break;
      }
    });

    function rotateLeft() {
      cube.rotation.y -= 0.1;
      markUserActive();
    }
    function rotateRight() {
      cube.rotation.y += 0.1;
      markUserActive();
    }
    function rotateUp() {
      camera.position.z -= 0.5;
      camera.position.z = Math.max(1, camera.position.z);
      markUserActive();
    }
    function rotateDown() {
      camera.position.z += 0.5;
      camera.position.z = Math.min(20, camera.position.z);
      markUserActive();
    }

    function animate() {
      requestAnimationFrame(animate);
      renderer.render(scene, camera);
    }
    animate();

    window.addEventListener('resize', () => {
      camera.aspect = window.innerWidth / window.innerHeight;
      camera.updateProjectionMatrix();
      renderer.setSize(window.innerWidth, window.innerHeight);
    });

    // =========================
    // 2. èªè¨€æ¨¡å‹ API ç›¸é—œ
    // =========================

    // âš ï¸ è«‹æ”¹æˆä½ çš„å¾Œç«¯ API ä½å€ï¼š
    // - åŒä¸€å°é›»è…¦æ¸¬è©¦ï¼š  "http://127.0.0.1:8000/chat"
    // - å€ç¶²å…¶ä»–è£ç½®é€£ç·šï¼š "http://140.130.33.131:8000/chat"  (ä¾ä½ çš„ IP èª¿æ•´)
    const API_URL = "https://1dpp4dm8-8000.asse.devtunnels.ms/chat";

    const inputBox  = document.getElementById("inputBox");
    const sendBtn   = document.getElementById("sendBtn");
    const voiceBtn  = document.getElementById("voiceBtn");
    const statusEl  = document.getElementById("status");
    const answerBox = document.getElementById("answerBox");

    // idleTimerï¼šèªéŸ³è¼¸å…¥å¾Œåœ 2 ç§’è‡ªå‹•é€å‡º
    let idleTimer = null;
    let inputValue = "";

    function resetIdleTimer() {
      if (idleTimer) clearTimeout(idleTimer);
      idleTimer = setTimeout(() => {
        if (inputValue.trim()) {
          console.log("â è‡ªå‹•ç™¼é€ï¼š", inputValue);
          sendToLLM(inputValue);        // è‡ªå‹•é€åˆ°èªè¨€æ¨¡å‹
          inputValue = "";
          inputBox.value = "";
        }
      }, 2000);
    }

    window.markUserActive = function () {
      resetIdleTimer();
    };

    // å°ˆé–€æ¥èªéŸ³è¾¨è­˜çµæœçš„å…¥å£
    window.showRecognizedText = function (text) {
      inputBox.value = text;
      inputValue = text;
      resetIdleTimer();

      // èªéŸ³ â†’ æ§åˆ¶ç«‹æ–¹é«”
      if (text.includes("å·¦")) rotateLeft();
      else if (text.includes("å³")) rotateRight();
      else if (text.includes("å‰") || text.includes("ç¸®å°")) rotateUp();
      else if (text.includes("å¾Œ") || text.includes("æ”¾å¤§")) rotateDown();
    };

    async function sendToLLM(textOverride) {
      const content = (textOverride !== undefined ? textOverride : inputBox.value).trim();
      if (!content) return;

      // æ›´æ–°ç‹€æ…‹ï¼šç”Ÿæˆä¸­
      statusEl.textContent = "ç‹€æ…‹ï¼šç”Ÿæˆä¸­...";
      answerBox.textContent = "";

      // ä½¿ç”¨ performance.now() åœ¨å‰ç«¯é‡æ¸¬æ™‚é–“
      const t0 = performance.now();

      try {
        const res = await fetch(API_URL, {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ message: content })
        });

        if (!res.ok) {
          throw new Error("HTTP ç‹€æ…‹ç¢¼ " + res.status);
        }

        const data = await res.json();
        const reply   = data.reply  || data.answer || JSON.stringify(data);
        let elapsed   = typeof data.elapsed === "number"
                        ? data.elapsed
                        : (performance.now() - t0) / 1000;

        // é¡¯ç¤ºå›ç­”
        answerBox.textContent = reply;
        statusEl.textContent  = "ç‹€æ…‹ï¼šå®Œæˆï¼Œç”¨æ™‚ " + elapsed.toFixed(2) + " ç§’";

      } catch (err) {
        statusEl.textContent = "âš ï¸ ç„¡æ³•é€£ç·šåˆ°èªè¨€æ¨¡å‹ä¼ºæœå™¨ï¼š" + err.message;
      }
    }

    // é€å‡ºæŒ‰éˆ• / è¼¸å…¥æ¡† Enter â†’ æ‰‹å‹•é€å‡º
    sendBtn.addEventListener("click", () => {
      sendToLLM();
    });

    inputBox.addEventListener("keydown", (e) => {
      if (e.key === "Enter") {
        e.preventDefault();  // é¿å…è§¸ç™¼èªéŸ³é‚£å€‹ Enter
        sendToLLM();
      }
    });

    // =========================
    // 3. ç€è¦½å™¨èªéŸ³è¾¨è­˜ï¼ˆWeb Speech APIï¼‰
    // =========================
    let recognition = null;

    function initSpeechRecognition() {
      const SR = window.SpeechRecognition || window.webkitSpeechRecognition;
      if (!SR) {
        console.warn("æ­¤ç€è¦½å™¨ä¸æ”¯æ´ Web Speech API èªéŸ³è¾¨è­˜");
        statusEl.textContent = "ç‹€æ…‹ï¼šæ­¤ç€è¦½å™¨ä¸æ”¯æ´èªéŸ³è¾¨è­˜";
        return;
      }

      recognition = new SR();
      recognition.lang = "zh-TW";
      recognition.continuous = false;
      recognition.interimResults = false;

      recognition.onresult = function (event) {
        const text = event.results[0][0].transcript;
        console.log("è¾¨è­˜çµæœï¼š", text);
        showRecognizedText(text);   // èªéŸ³çµæœ â†’ æ§åˆ¶ + å¡«å…¥æ–‡å­—
      };

      recognition.onerror = function (event) {
        console.error("èªéŸ³è¾¨è­˜éŒ¯èª¤ï¼š", event.error);
        statusEl.textContent = "èªéŸ³è¾¨è­˜éŒ¯èª¤ï¼š" + event.error;
      };

      recognition.onend = function () {
        console.log("èªéŸ³è¾¨è­˜çµæŸ");
      };

      console.log("èªéŸ³è¾¨è­˜åˆå§‹åŒ–å®Œæˆ");
    }

    function playBeepAndStartRecognition() {
      const beep = document.getElementById("startBeep");
      beep.currentTime = 0;
      beep.play().catch(() => {}); // æœ‰äº›ç€è¦½å™¨å¯èƒ½æœƒæ“‹ï¼Œå¿½ç•¥éŒ¯èª¤å³å¯

      if (recognition) {
        recognition.stop();
        recognition.start();
        statusEl.textContent = "ç‹€æ…‹ï¼šæ­£åœ¨è½ï¼Œè«‹èªªè©±...";
      } else {
        statusEl.textContent = "ç‹€æ…‹ï¼šæ­¤ç€è¦½å™¨ä¸æ”¯æ´èªéŸ³è¾¨è­˜";
      }
    }

    // èªéŸ³æŒ‰éˆ•ä¹Ÿå¯ä»¥å•Ÿå‹•è¾¨è­˜
    voiceBtn.addEventListener("click", () => {
      playBeepAndStartRecognition();
    });

    window.onload = function () {
      initSpeechRecognition();
      statusEl.textContent = "ç‹€æ…‹ï¼šå¾…å‘½ï¼ˆEnter æˆ–æŒ‰ ğŸ¤ é–‹å§‹èªéŸ³ï¼‰";
    };
  </script>
</body>
</html>
